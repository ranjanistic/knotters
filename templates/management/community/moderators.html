{% extends 'management/community/index.html' %}

{% block nav_href %}{{URLS.COMMUNITY}}{% endblock %}
{% block nav_text %}Moderators{% endblock %}
{% block content %}
<div class="w3-row">
    <div class="w3-col w3-half w3-padding">
        <h4>Existing moderators</h4>
        <span id="new-moderators-view"></span>
        {% for mod in moderators %}
        <div class="w3-row pallete-slab" id="pallete-remove-{{mod.getUserID}}">
            <div class="w3-col s1">
                <img src="{{mod.getDP}}" class="w3-circle primary" width="50" />
            </div>
            <div class="w3-col s8 w3-padding-small">
                <div class="w3-row">
                    {{mod.getName}} {{mod.get_xp}}
                </div>
                <div class="w3-row">
                    {{mod.getEmail}}
                </div>
            </div>
            <div class="w3-col s3 w3-padding-small">
                <div class="w3-row w3-right">
                    <a href="{{mod.getLink}}" target="_blank"><button class="small primary">View</button></a>
                </div>
                <div class="w3-row w3-right">
                    <button class="small negative remove-moderator" data-profileurl="{{mod.getLink}}" data-name="{{mod.getName}}" data-userID="{{mod.getUserID}}">Remove</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="w3-col w3-half w3-padding">
    <h4>Promote as moderators</h4>
    <input class="wide" placeholder="Type to search profiles" id="search-profile-input" />
    <br/><br/>
    <span id="profile-search-results"></span>
    <h5>Suggested</h5>
    {% for mod in profiles %}
        <div class="w3-row pallete-slab" id="pallete-add-{{mod.getUserID}}">
            <div class="w3-col s1">
                <img src="{{mod.getDP}}" class="w3-circle primary" width="50" />
            </div>
            <div class="w3-col s8 w3-padding-small">
                <div class="w3-row">
                    {{mod.getName}} {{mod.get_xp}}
                </div>
                <div class="w3-row">
                    {{mod.getEmail}}
                </div>
            </div>
            <div class="w3-col s3 w3-padding-small">
                <div class="w3-row w3-right">
                    <a href="{{mod.getLink}}" target="_blank"><button class="small primary">View</button></a>
                </div>
                <div class="w3-row w3-right">
                    <button class="small positive add-moderator" data-profileurl="{{mod.getLink}}" data-name="{{mod.getName}}" data-userID="{{mod.getUserID}}">Promote</button>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const loadRemoveMods = () => {
getElements('remove-moderator').forEach((remove)=>{
    remove.onclick=(e)=>{
        alertify.confirm('Remove as moderator?', `<h5>Are you sure that you want to ${NegativeText('remove')} 
            <span class="positive-text" onclick="miniWindow('${e.target.getAttribute('data-profileurl')}')">${e.target.getAttribute('data-name')}</span>
             as a moderator on ${APPNAME}? Their pending moderations will be transferred to a new moderator. (You are not deleting their account)</h5>`,
             async ()=>{
                const modID = e.target.getAttribute('data-userID');
                const modname = e.target.getAttribute('data-name');
                const data = await postRequest('{{URLS.REMOVE_MODERATOR}}', {modID})
                if (!data) return
                if (data.code == code.OK){
                    message(`Removed ${modname} as moderator`)
                    return hideElement(`pallete-remove-${modID}`)
                }
                error(data.error)
             },
             ()=>{}
        ).set('labels', {ok:'Yes, remove', cancel: 'No, wait'}).set('closable', false)
    }
})
}
getElement('search-profile-input').oninput=async(e)=>{
    const resview = getElement('profile-search-results')
    if(!e.target.value.trim()) {
        resview.innerHTML = ''
        return loadAddMods()
    }
    const data = await postRequest(URLS.ELGIBLE_MODSEARCH, {query:e.target.value})
    if(!data) return
    if (data.code!==code.OK) return
    const mod = data.mod;
    setHtmlContent(resview,`<div class="w3-row pallete-slab" id="pallete-add-${data.mod.userID}">
            <div class="w3-col s1">
                <img src="${mod.dp}" class="w3-circle primary" width="50" />
            </div>
            <div class="w3-col s8 w3-padding-small">
                <div class="w3-row">
                    ${mod.name}
                </div>
                <div class="w3-row">
                    ${mod.email}
                </div>
            </div>
            <div class="w3-col s3 w3-padding-small">
                <div class="w3-row w3-right">
                    <a href="${mod.url}" target="_blank"><button class="small primary">View</button></a>
                </div>
                <div class="w3-row w3-right">
                    <button class="small positive add-moderator" data-profileurl="${mod.url}" data-name="${mod.name}" data-userID="${mod.userID}">Promote</button>
                </div>
            </div>
        </div>`, loadAddMods);
    
}

const loadAddMods = () => {
    getElements('add-moderator').forEach((add)=>{
        add.onclick=(e)=>{
            alertify.confirm('Promote as moderator?', `<h5>Are you sure that you want to promote 
                <span class="positive-text" onclick="miniWindow('${e.target.getAttribute('data-profileurl')}')">${e.target.getAttribute('data-name')}</span>
                as a moderator on ${APPNAME}?</h5>`,
                async ()=>{
                    const userID = e.target.getAttribute('data-userID');
                    const username = e.target.getAttribute('data-name');
                    const data = await postRequest(URLS.ADD_MODERATOR, {userID})
                    if (!data) return
                    if (data.code == code.OK){
                        message(`Promoted ${username} as moderator`)
                        hideElement(`pallete-add-${userID}`)
                        let newmod = getElement(`pallete-add-${userID}`).innerHTML.replaceAll('add-', 'remove-').replaceAll('positive', 'negative').replaceAll('Promote', 'Remove')
                        getElement('new-moderators-view').innerHTML += `<div class="w3-row pallete-slab" id="pallete-remove-${userID}">${newmod}</div>`
                        loadRemoveMods()
                        return
                    }
                    error(data.error)
                },
                ()=>{}
            ).set('labels', {ok:'Yes, promote', cancel: 'No, wait'}).set('closable', false)
        }
    })
}
loadRemoveMods()
loadAddMods()
</script>
{% endblock %}