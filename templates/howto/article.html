{% extends 'howto/index.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% load tz %}
{% load cache %}
{% load custom_tags %}

{% block content %}
<div class="w3-row">
    <div class="w3-col w3-container m7 l8">
        <div class="w3-row"><h1>{{article.heading}}</h1></div>
        <div class="w3-row text-medium">{{article.subheading}}</div>
        <br />
        <div class="w3-row">
            <div class="w3-col m3 l3"><span class="dead-text">{{article.createdOn}}</span></div>
            <div class="w3-col m9 l9">
                <div id="view-articletags">
                    {% for tag in article.tags.all %}
                    <a href="{{URLS.HOWTO}}?search=tag:{{tag}}"><button class="small positive">#{{tag}}</button></a>
                    {% empty %}
                        <strong class="dead-text">{% trans "No tags assigned" %}</strong>
                    {% endfor %}
                    {% if self %}<i class="edit-action" data-edittarget="articletags">edit</i>{% endif %}
                </div>
                {% if self %}
                <div id="edit-articletags">
                    <strong class="dead-text">{% trans "Total 5 tags allowed" %}</strong>
                    <form class="no-auto" id="edit-tag-inputs">
                        {% csrf_token %}
                        <input class="tertiary" maxlength="40" placeholder="{% trans "Search tags" %}" id="tag-search-input" />
                        <div class="w3-row w3-padding" id="tags-viewer">
                            {% for tag in article.tags.all %}
                            <button type="button" class="primary small negative-text tag-existing" data-icon="close" id="{{tag.id}}">{{tag.name}}</button>
                            {% endfor %}
                            <div class="w3-row w3-padding" id="tags-viewer-new"></div>
                        </div>
                        <input id="removetagIDs" name="removetagIDs" hidden type="text" />
                        <input id="addtagIDs" name="addtagIDs" hidden type="text" />
                        <input id="addtags" name="addtags" hidden type="text" />
                        <button class="small" id="save-edit-articletags" data-icon="done">{% trans "Save" %}</button>
                        <button class="small" id="discard-edit-articletags" data-icon="close">{% trans "Cancel" %}</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="w3-col w3-container m4 l3 w3-right">
        <div class="w3-row">
            <a href="{{article.author.getLink}}">
                <div class="w3-col s9 m9 l9 w3-right-align">
                    <strong class="text-medium text-primary">{{article.author.getName}}</strong>
                {% if article.author.is_verified %}<i class="positive-text w3-large">verified</i>{% endif %}
                <br />
                <span class="dead-text">{{article.author.getXP}}</span>
                </div>
                <div class="w3-col w3-container s3 m3 l3">
                    <img class="w3-circle" src="{{article.author.getDP}}"  width="50"/>
                </div>
            </a>
        </div>
        {% if request.user.is_authenticated %}
        <div class="w3-row w3-center trigger-article-rating">
        {% else %}
        <div class="w3-row w3-center trigger-login-popup">
        {% endif %}
            <span class="text-large">{{ article.get_avg_rating }}</span>
            <br>
                <div class="rate">
                    {% for i in '0123456789'|make_list %}
                    <input type="checkbox" required/>
                    <label class="{% if forloop.counter0|divisibleby:"2" %}half{% endif %} {% if forloop.counter0 < article.get_rating_out_of_ten %}selected{% endif %}"></label>
                    {% endfor %}
                </div>
            <br>
            <span class="text-small">{{ article.total_ratings }} rating{{ article.total_ratings|pluralize }}</span>
        </div>
        <div class="w3-row" >
            <a id="show-admirations"><strong>{{ article.total_admirers }} admirer{{ article.total_admirers|pluralize }}</strong></a>
            {% if request.user.is_authenticated %}
            <form method="POST" action="{{ URLS.TOGGLE_ADMIRATION|params:article.id }}">
                {% csrf_token %}
                <input type="hidden" value="{% if isAdmirer %}false{% else %}true{% endif %}" name="admire" />
                <button type="submit" class="w3-right {% if isAdmirer %}positive{% else %}primary{% endif %}" data-icon="volunteer_activism" id="toggle-admiration" ></button>
            </form>
            {% else %}
            <a href="{{URLS.Auth.LOGIN}}?next={{request.path}}"><button class="w3-right primary" data-icon="volunteer_activism"></button></a>
            {% endif %}
        </div> 
        <div class="w3-row w3-center">
            <div id="view-articletopics">
                {% for topic in article.topics.all %}
                    <a href="{{URLS.HOWTO}}?search=topic:{{topic}}">
                        <button class="button topic-name primary border-joy">
                        {{topic}}
                        </button>
                    </a>
                {% empty %}
                    {% if self %}
                        <br/>
                        <button class="accent edit-action big-button" data-edittarget="articletopics" data-icon="add">Add topics</button>
                    {% else %}
                        <br/>
                        <div class="dead-text">
                            <i class="w3-big">scatter_plot</i>
                            <h4>No topics yet</h4>
                        </div>
                    {% endif %}
                {% endfor %}
                <strong>{% if self and article.topics.all|length > 0 %}<i class="edit-action" data-edittarget="articletopics">edit</i>{% endif %}</strong>
            </div>
            {% if self %}
            <div id="edit-articletopics" hidden>
                <br/>
                <strong class="dead-text">Total 3 topics allowed</strong>
                <form class="no-auto" method="POST" id="edit-article-topics-form">
                    {% csrf_token %}
                    <input class="wide" placeholder="Search topics" id="topic-search-input" maxlength="35" />
                    <div class="w3-row w3-padding" id="topics-viewer">
                        {% for topic in article.getTopics %}
                        <button type="button" class="primary negative-text topic-existing" data-icon="close" id="{{topic.getID}}">{{topic.name}}</button>
                        {% endfor %}
                        <div class="w3-row w3-padding" id="topics-viewer-new"></div>
                    </div>
                    <input id="removetopicIDs" name="removetopicIDs" hidden type="text" />
                    <input id="addtopicIDs" name="addtopicIDs" hidden type="text" />
                    <input id="addtopics" name="addtopics" hidden type="text" />
                    <br/>
                    <button id="save-edit-articletopics" data-icon="done">Save</button>
                    <button id="discard-edit-articletopics" data-icon="close">Cancel</button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<br />
<div class="w3-row" style="display:flex">
    <div class="w3-col w3-conatiner m4 l3 tertiary" style="border-top-right-radius : 10px;">
        {% for section in sections %}
        <div class="w3-row w3-center">
            <br />
            <a href="#view-section-{{ forloop.counter }}">
                <strong><span class="text-primary text-medium">{{section.subheading}}</span></strong>
            </a>
        </div>
        {% endfor %}
    </div>
    <div class="w3-col w3-container m8 l9">
        <div class="w3-row">
            {% include 'howto/sections.html' %}
        </div>
        <br />
        <div class="w3-row">
            {% if self and article.isEditable %}
                <div class="w3-row w3-center" id="view-section">
                    <button class="large edit-action" data-icon='add' id="create-snap" data-edittarget="section">Add Section</button>
                </div>
                <div class="w3-row" id="edit-section">
                    <br />
                    <input type='file' hidden id='section-file-0' accept="image/png, image/jpg, image/jpeg"/>
                    <form action="{{URLS.SECTION|params:article.id|params:'create'}}" method="POST">
                        {% csrf_token %}
                        <input class="wide" type="text" name="subheading" placeholder="subheading">
                        <textarea class="wide" style="margin-top: 1rem" name='paragraph' rows="3" placeholder="Paragraph"></textarea>
                        <input type="text" id='imageData-0' name='image' hidden value=""/>
                        <img hidden width='20%' id='imageOutput-0' class="preview-type-image" />
                        <div class="dead-text" id='add-image-view-0'>
                            <label for="section-file-0">
                                <div class="w3-jumbo material-icons">add_circle</div>
                                <h5>Add image</h5>
                            </label>
                        </div>
                        <button class="small positive" type='submit' id="save-edit-section" data-icon="done">{% trans "Publish Section" %}</button>
                        <button class="small negative" type='button' id="discard-edit-section" data-icon="close">{% trans "Discard" %}</button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- <input type="hidden" value="{{ article.id }}" id="articleid">
<input type="hidden" value="{{ article.is_draft }}" id="draft"> -->
{% endblock %}
{% block scripts %}
<script nonce="{{request.csp_nonce}}" src="{{URLS.SCRIPTS_SUBAPP|params:SUBAPPNAME|params:SCRIPTS.ARTICLE}}?nickname={{article.nickname}}"></script>
{% endblock %}

{% comment %}
    {% if self %}
        <br />
        <div class="w3-row pallete">
            <h5 class="align"><i class="w3-spin">settings</i>&nbsp;{% trans "Settings" %}</h5>
            <br />
            <div class="w3-row align">
                <button id="deleteArticle" class="negative w3-large w3-animate-zoom" type="submit">Delete Article</button>
                <button id="draftArticle" class="accent w3-large w3-animate-zoom">
                    {% if article.is_draft %}
                    Publish Article
                    {% else %}
                    Draft Article
                    {% endif %}
                </button>
            </div>
        </div>
    {% endif %}
{% endcomment %}