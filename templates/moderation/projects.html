{% extends 'moderation/index.html' %}

{% block content %}
<div class="w3-row w3-padding">
    <center><h4 class="dead-text">
    {% if moderation.resolved %}
    This moderation has been resolved.
    {% else %}
        {% if ismoderator %}
        Because you are our moderator and we trust you, here's a moderation for you.
        {% else %}
        The moderator is reviewing your project, and once it's done, we'll notify you.
        {% endif %}
    {% endif %}
    </h4></center>
    <br/>
    <div class="w3-col w3-half w3-padding">
        <img class="w3-right w3-circle" width="150" src="{{moderation.project.getDP}}">
        <h5 class="dead-text">Status: <span class="text-primary">{{moderation.status|capfirst}}</span></h5>
        <h5 class="dead-text">Category: <span class="text-primary">{{moderation.type|capfirst}}</span></h5>
        <h2>{{moderation.project.name}}</h2>
        {% if moderation.project.isLive %}
        <a target="_blank" href="{{moderation.project.getRepoLink}}"><h4 class="positive-text">github.com/Knotters/<span class="text-primary">{{moderation.project.reponame}}</span></h4></a>
        {% else %}
        <h4 class="dead-text">github.com/Knotters/<span class="text-primary">{{moderation.project.reponame}}</span></h4>
        {% endif %}
        {% if moderation.referURL %}
        <a onclick="miniWindow('{{moderation.referURL}}')" title="Be careful with the URLs provided by requestors." class="positive-text"><strong>{{moderation.referURL}}</strong></a><br/>
        {% endif %}

        Requested on <strong>{{moderation.requestOn}}</strong><br/><br/>
        <form method="POST" action="{{ROOT}}/message/{{moderation.id}}">
        {% csrf_token %}
        <strong>Requestor message</strong>
        {% if ismoderator %}<button class="w3-right report-button" data-icon="warning">Report</button><br/>{% endif %}

        <textarea required name="requestdata" class="wide" rows="4" maxlength="6000" placeholder="This is visible to the moderator."
        {% if ismoderator or moderation.resolved %}disabled{% endif %}
        >{{moderation.request}}</textarea>
        {% if not ismoderator and not moderation.resolved %}
        <button type="submit" class="positive small w3-right" data-icon="send">Save</button>
        {% endif %}
        <br/><br/>
        <strong>Moderator response</strong>
        <textarea required name="responsedata" class="wide" rows="4" maxlength="8000"
        {% if not ismoderator or moderation.resolved %}disabled placeholder="No response"{% endif %}
        {% if ismoderator and not moderation.resolved %}placeholder="This is visible to the requestor."{% endif %}
        >{% if moderation.response %}{{moderation.response}}{% endif %}</textarea>
        {% if not ismoderator %}<button class="w3-right report-button"><i class="material-icons">warning</i>Report</button><br/>{% endif %}
        {% if ismoderator and not moderation.resolved %}
        <button type="submit" class="positive small w3-right" data-icon="send">Save</button>
        {% endif %}
        </form>
        {% if moderation.respondOn %}
            Last response on <strong>{{moderation.respondOn}}</strong><br/>
        {% endif %}
    </div>
    
    <div class="w3-col w3-half w3-padding">
        <div class="w3-row pallete accent w3-center">
        <br/>
        {% if ismoderator and not moderation.resolved %}
        <i class="w3-jumbo material-icons">warning</i>
        <h3 class="text-accent">Take Action</h3>
        <h6>Approving this project will create a repository under {{APPNAME}} organization on GitHub, and will grant the requestor a moderate level
        of access to this project and related services, everywhere. Therefore, decide thoughtfully before proceeding.</h6>
        <button class="big-button positive modaction" id="approve" data-icon="done">Approve</button>
        <button class="big-button negative modaction" id="reject" data-icon="close">Reject</button>
        {% else %}
            <i class="w3-jumbo material-icons">{% if moderation.resolved %}task_alt{% else %}pending{% endif %}</i>
            <h3 class="text-accent">Action taken</h3>
            <h4>{% if moderation.resolved %}{{moderation.status|capfirst}}{% else %}Pending{% endif %}</h4>
            {% if moderation.project.isLive %} 
            <a href="{{moderation.project.getLink}}" target="_blank"><button class="positive" data-icon="open_in_new">View</button></a>
            {% endif %}
            {% if not ismoderator and moderation.resolved and moderation.isRejected %}
            <h2>{{moderation.project.moderationRetriesLeft}} retries left.</h2>
                {% if moderation.project.canRetryModeration %}
                <form method="POST" action="{{moderation.reapplyLink}}">
                {% csrf_token %}
                <button class="secondary" type="submit" data-icon="refresh">Re-apply for moderation</button>
                </form>
                {% endif %}
            <br/>
            {% endif %}
        {% endif %}
        
        </div>
        <br/>
        <div class="w3-row w3-padding">
        <h5>Do respect and follow <a class="positive-text" onclick="miniWindow('/docs/communityguidelines')">community guidelines</a> in any kind of conversation.</h5>
        <h5>You can go through the <a class="positive-text" onclick="miniWindow('/docs/moderationguidelines')">moderation guidelines</a> for any doubt or help regarding this.</h5>
        <h5>For <a class="positive-text" onclick="miniWindow('/docs/privacypolicy')">privacy reasons</a>, we keep the identity of requestor and moderator anonymous to each other.</h5>
        </div>
    </div>
</div>
<br/>
{% endblock%}

{% block scripts %}
<script>
getElements("modaction").forEach((action)=>{
    action.addEventListener('click',()=>{
        alertify.confirm(`<h5>Final confirmation</h5>`, `<strong class="text-tertiary w3-large">Are you sure that to <h4>${action.id}</h4> this project -
            <h5>{{moderation.project.name}}</h5> (@{{moderation.project.reponame}}) <br/>- will be your final decision?
        <br/><br/>
        <h5>This action is irreversible.</h5></b>`,
        async ()=>{
            subLoader(true);
            loader(true);
            message('Resolving moderation, please wait.')
            const data = await postRequest(`${ROOT}/action/{{moderation.id}}`, {
                approve: action.id === 'approve'
            })
            if(data.code === code.OK){
                success('Resolved!')
                window.location.reload()
            } else {
                subLoader(false);
                loader(false);
                error(data.error)
            }
        },
        ()=>{

        }
        ).set('labels', {ok:`Yes, ${action.id} this project`, cancel:'No, wait!'}); 
    })
})
</script>
{% endblock %}