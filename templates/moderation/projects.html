{% extends 'moderation/index.html' %}
{% load i18n %}
{% load l10n %}
{% load tz %}
{% load custom_tags %}

{% block content %}
<div class="w3-row w3-padding">
    <center><h4 class="dead-text">
    {% if moderation.resolved %}
    This moderation has been resolved.
    {% else %}
        {% if ismoderator %}
        Because you are our moderator and we trust you, here's a moderation for you.
        {% else %}
        The moderator is reviewing your project, and once it's done, we'll notify you.
        {% endif %}
    {% endif %}
    </h4></center>
    <br/>
    <div class="w3-col w3-half w3-padding">
        <img class="w3-right w3-circle" width="150" src="{{moderation.project.getDP}}">
        <h5 class="dead-text">Status: <span class="text-primary">{{moderation.status|capfirst}}</span></h5>
        <h5 class="dead-text">Category: <span class="text-primary">{{moderation.type|capfirst}}</span></h5>
        <h5 class="dead-text">License: <a onclick="miniWindow('{{URLS.PROJECTS}}{{moderation.project.license.getLink}}')" target="_blank">{{moderation.project.license.name}}</a></h5>
        <h2>{{moderation.project.name}}</h2>
        {% if moderation.project.isLive %}
        <a target="_blank" href="{{moderation.project.getRepoLink}}"><h4 class="positive-text">github.com/Knotters/<span class="text-primary">{{moderation.project.reponame}}</span></h4></a>
        {% else %}
        <h4 class="dead-text">github.com/Knotters/<span class="text-primary">{{moderation.project.reponame}}</span></h4>
        {% endif %}
        {% if moderation.referURL %}
        <a onclick="miniWindow('{{moderation.referURL}}')" title="Be careful with the URLs provided by requestors."><strong>{{moderation.referURL}}</strong></a><br/>
        {% endif %}
        Requested on <strong>{{moderation.requestOn}}</strong><br/><br/>
        <form method="POST" action="{{URLS.MESSAGE|params:moderation.getID}}">
        {% csrf_token %}
        <strong>Requestor message</strong>
        {% if ismoderator %}<button class="w3-right report-button" data-icon="warning" onclick="reportFeedbackView()">Report</button><br/>{% endif %}

        <textarea required name="requestdata" class="wide" rows="4" maxlength="6000" placeholder="This is visible to the moderator."
        {% if ismoderator or moderation.resolved %}disabled{% endif %}
        >{{moderation.request}}</textarea>
        {% if not ismoderator and not moderation.resolved %}
        <button type="submit" class="positive small w3-right" data-icon="send">Save</button>
        {% endif %}
        <br/><br/>
        <strong>Moderator response</strong>
        <textarea required name="responsedata" class="wide" rows="4" maxlength="8000"
        {% if not ismoderator or moderation.resolved %}disabled placeholder="No response"{% endif %}
        {% if ismoderator and not moderation.resolved %}placeholder="This is visible to the requestor."{% endif %}
        >{% if moderation.response %}{{moderation.response}}{% endif %}</textarea>
        {% if not ismoderator %}<button class="w3-right report-button" onclick="reportFeedbackView()"><i class="material-icons">warning</i>Report</button><br/>{% endif %}
        {% if ismoderator and not moderation.resolved %}
        <button type="submit" class="positive small w3-right" data-icon="send">Save</button>
        {% endif %}
        </form>
        {% if moderation.respondOn %}
            Last response on <strong>{{moderation.respondOn}}</strong><br/>
        {% endif %}
    </div>
    
    <div class="w3-col w3-half w3-padding">
        <div class="w3-row pallete accent w3-center">
        <br/>
        {% if ismoderator and not moderation.resolved %}
        <i class="w3-jumbo material-icons">warning</i>
        <h3 class="text-accent">Take Action</h3>
        <h6>Approving this project will create a repository under {{APPNAME}} organization on GitHub, and will grant the requestor a moderate level
        of access to this project and related services, everywhere. Therefore, decide thoughtfully before proceeding.</h6>
        <button class="big-button positive modaction" id="approve" data-icon="done">Approve</button>
        <button class="big-button negative modaction" id="reject" data-icon="close">Reject</button>
        {% else %}
            <i class="w3-jumbo material-icons">{% if moderation.resolved %}task_alt{% else %}pending{% endif %}</i>
            <h3 class="text-accent">Action taken</h3>
            <h4>{% if moderation.resolved %}{{moderation.status|capfirst}}{% else %}Pending{% endif %}</h4>
            {% if moderation.project.isLive %} 
            <a href="{{moderation.project.getLink}}" target="_blank"><button class="positive" data-icon="open_in_new">View project</button></a>
            {% endif %}
            {% if not ismoderator %}
                {% if moderation.resolved and moderation.isRejected and not forwarded%}
                    {% if moderation.project.canRetryModeration %}
                        <h2>{{moderation.project.moderationRetriesLeft}} retries left.</h2>
                        <form method="POST" action="{{moderation.reapplyLink}}">
                        {% csrf_token %}
                        <button class="secondary" type="submit" data-icon="refresh">Re-apply for moderation</button>
                        </form>
                    {% endif %}
                    {% if not moderation.project.trashed %}
                        <form method="POST" action="{{URLS.PROJECTS}}{{moderation.project.getTrashLink}}">
                        {% csrf_token %}
                        <button class="negative" type="submit" data-icon="delete">Delete project</button>
                        </form>
                    {% else %}
                        <h4>Project deleted</h4>
                    {% endif %}
                {% elif forwarded %}
                    <h4>Moderation re-applied</h4>
                    <a href="{{forwarded.getLink}}"><button class="positive" data-icon="open_in_new">View moderation</button></a>
                {% endif %}
            {% endif %}
        {% endif %}
        
        </div>
        <br/>
        <div class="w3-row w3-padding">
        <h5>Do respect and follow <a onclick="miniWindow('{{URLS.Docs.TYPE|params:'communityguidelines'}}')">community guidelines</a> in any kind of conversation.</h5>
        <h5>You can go through the <a onclick="miniWindow('{{URLS.Docs.TYPE|params:'moderationguidelines'}}')">moderation guidelines</a> for any doubt or help regarding this.</h5>
        <h5>For <a onclick="miniWindow('{{URLS.Docs.TYPE|params:'privacypolicy'}}')">privacy reasons</a>, we keep the identity of requestor and moderator anonymous to each other.</h5>
        </div>
    </div>
</div>
<br/>
{% endblock%}

{% block scripts %}
<script>
{% if ismoderator %}
getElements("modaction").forEach((action)=>{
    const approve = action.id === 'approve';
    const modaction = async() => {
        loader(true);
        message('Resolving moderation, please wait.')
        const data = await postRequest(`{{URLS.ACTION|params:moderation.getID}}`, {approve})
        if (!data) return loader(false);;
        if(data.code === code.OK){
            success('Resolved.')
            window.location.reload()
        } else {
            loader(false);
            error(data.error)
        }
    }
    action.addEventListener('click',()=>{
        alertify.confirm(
            `<h5>Final confirmation</h5>`,
            `<h4>Are you sure that to <span class="${approve?'positive':'negative'}-text">${action.id}</span> this project {{moderation.project.name}} (@{{moderation.project.reponame}}) 
            will be your final decision?
                <br/><br/>
            <h5>This action is irreversible.</h5>`,
        async ()=>{
            if (approve){
                await modaction()   
            }
        },
        async()=>{
            if (!approve){
                await modaction()
            }
        }
        ).set('closable',false).set('labels', {
            cancel:approve?'No, wait!':`${Icon('done')} Yes, ${action.id} this project`,
            ok:!approve?'No, wait!':`${Icon('done')} Yes, ${action.id} this project`,
        })
        .set('reverseButtons', !approve);
    })
})
{% endif %}
</script>
{% endblock %}