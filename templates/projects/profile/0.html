{% extends 'projects/profile.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% load tz %}
{% load cache %}
{% load custom_tags %}

{% block nav_style %}positive{% endblock %}
{% block nav_text_style %}text-positive{% endblock %}
{% block nav_back_theme %}primary{% endblock %}

{% block content %}
<div class="w3-row tertiary">
    <br/>
{% if project.suspended %}
    <div class="w3-row w3-center w3-padding">
      <i class="w3-jumbo negative-text">toggle_off</i>
      <h2>{% trans "This project is currently suspended." %}</h2><br/>
      <h3>{% trans "This means the project is currently invisible to the world." %}</h3>
      <strong>{% trans "We must have emailed you regarding this action, please check your inbox." %}</strong>
    </div>
    <br/><br/>
    <br/>
{% else %}
    <div class="w3-col w3-quarter w3-padding">
        <div class="w3-row">
            <div class="pallete w3-center w3-animate-zoom" style="padding:0" id="view-pallete">
                <img src="{{project.getDP}}" alt="{{project.name}}" class="preview-type-image" />
                <div class="w3-row w3-padding">
                  <h5>{{project.name}}</h5>
                  <center>{{project.description}}</center>
                </div>
                <div class="w3-row w3-padding-small">
                    {% if iscreator %}
                    <i class="material-icons edit-action w3-right" data-edittarget="pallete">edit</i>
                    {% endif %}
                    <i class="w3-left pointer navigator-share-action" 
                        data-title="{{project.name}}"
                        data-text="{{project.description|or:'Checkout this project!'}}"
                        data-url="{{project.getLink}}"
                    >share</i>
                </div>
            </div>
            {% if iscreator %}
            <div class="pallete w3-center" id="edit-pallete">
                <img src="{{ project.getDP }}" alt="{{ project.name }}" id="projectimageoutput" style="opacity:0.5" />
                <input type="file" id="uploadprojectimage" hidden accept="image/png, image/jpg, image/jpeg" />
                <button class="positive small" type="button" id="upload-button">
                <i>upload</i>
                <label id="uploadprojectimagelabel" for="uploadprojectimage">{% trans "Select Image" %}</label>
                </button>
                <br/>
                <form method="POST" action="{{URLS.PROFILEEDIT|params:project.get_id|params:'pallete'}}">
                {% csrf_token %}
                <input type="text" hidden id="projectimageData" name="projectimage" value="" />
                <div class="w3-row w3-padding">
                    <input maxlength="70" type="text" autocomplete="organization-title" autocapitalize placeholder="Project name" required value="{{project.name}}" name="projectname" /><br/><br/>
                    <textarea maxlength="120" class="wide" placeholder="About project" name="projectabout" >{{project.description}}</textarea><br/>
                </div>
                <button id="save-edit-pallete" data-icon="done">{% trans "Save" %}</button>
                <button id="discard-edit-pallete" data-icon="close">{% trans "Discard" %}</button>
                </form>
            </div>
            {% endif %}
        </div>
        
        <br/>
        {% if project.has_linked_repo %}
        <div class="w3-row w3-padding-small">
            <a target="_blank" rel="noreferrer" href="{{project.linked_repo.repolink}}">
                <button class="secondary"><img src="{% static 'graphics/thirdparty/github-dark.png' %}" width="20"/>&nbsp;{{project.linked_repo.reponame}}</button>
            </a>
        </div>
        <br/>
        {% endif %}

        <div class="w3-row w3-padding-small">
        <a id="show-admirations"><strong>{{ project.total_admiration }} admirer{{ project.total_admiration|pluralize }}</strong></a>
        {% if request.user.is_authenticated %}
            <form method="POST" action="{{ URLS.TOGGLE_ADMIRATION|params:project.get_id }}">
                {% csrf_token %}
                <input type="hidden" value="{% if isAdmirer %}false{% else %}true{% endif %}" name="admire" />
                <button type="submit" class="w3-right {% if isAdmirer %}positive{% else %}primary{% endif %}" data-icon="volunteer_activism"></button>
            </form>
        {% else %}
            <a href="{{URLS.Auth.LOGIN}}?next={{request.path}}"><button class="w3-right primary" data-icon="volunteer_activism"></button></a>
        {% endif %}
        </div>
        <br/>

        {% if not iscreator and user.is_authenticated %}
        <div class="w3-row">
            <button class="small tertiary negative-text" data-icon="report" id='report-project'>{% trans "Report" %}</button>
        </div>
        <br />
		{% endif %}

        <div class="w3-row pallete">
            <center><h5 class="align"><i>open_in_new</i>&nbsp;Links</h5></center>
            <div class="" id="view-sociallinks">    
                {% if project.socialsites.count %}
                    {% for site in project.socialsites %}
                        <a class="" href="{{site.site}}" target="_blank" rel="noreferrer">
                            <div class="pallete-slab w3-left align positive-text">
                            <i class="w3-large">open_in_new</i>&nbsp;<strong>{{site.site|noprotocol|truncatechars:30}}</strong>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <br/>
                    <center class="dead-text">
                        <div class="w3-jumbo material-icons">link_off</div>
                        <h5>No links</h5>
                    </center>
                {% endif %}
                {% if iscreator %}
                    <div class="w3-row">
                    <i class="material-icons edit-action w3-right" data-edittarget="sociallinks">edit</i>
                    </div>
                {% endif %}
            </div>
            <div class="w3-center " id="edit-sociallinks" hidden>
                <form method="POST" action="{{URLS.PROFILEEDIT|params:project.get_id|params:'sociallinks'}}">
                {% csrf_token %}
                <div id="edit-sociallinks-inputs">
                {% for site in project.socialsites %}
                    <div>
                        <input type="url" class="wide"  placeholder="Link to anything relevant" value="{{site.site}}" name="sociallink{{forloop.counter}}" id="sociallink{{forloop.counter}}" /><br/><br/>
                    </div>
                {% endfor %}
                </div>
                <br/>
                <button class="primary" type="button" id="sociallinks-add" data-icon='add'>Add link</button><br/><br/>
                <button id="save-edit-sociallinks" data-icon="done">{% trans "Save" %}</button>
                <button id="discard-edit-sociallinks" data-icon="close">{% trans "Discard" %}</button>
                </form>
            </div>
        </div>
        <br/>

        {% if project.repolink %}
        <div class="w3-row w3-padding-small">
            <a target="_blank" rel="noreferrer" href="{{project.repoLink}}">
                <button class="secondary"><img src="{% static 'graphics/thirdparty/github-dark.png' %}" width="20"/>&nbsp;{{project.repolink}}</button>
            </a>
        </div>
        <br/>
        {% endif %}
    </div>
    <div class="w3-col w3-threequarter">
        <div class="w3-col w3-half w3-padding">
            <div class="w3-row w3-center">
                <div class="pallete">
                    <center><h5 class="align"><i>notes</i>&nbsp;Overview</h5></center><br/>
                    <a href="{{URLS.PROJECTS}}?search=category:{{project.category.name}}" ><span class="pallete-slab positive text-positive text-big">{{project.category.name|capfirst}}</span></a>
                    <br/>
                    <div class="w3-row" id="view-projecttopics">
                    {% for topicdata in project.getTopicsData %}
                        <a href="{{URLS.PROJECTS}}?search=topic:{{topicdata.topic}}">
                            <button class="positive big-button topic-name">
                            {{topicdata.topic}}
                            </button>
                        </a>
                    {% empty %}
                        {% if iscreator %}
                            <button class="accent edit-action big-button" data-edittarget="projecttopics" data-icon="add">Add topics</button>
                        {% else %}
                            <br/>
                            <div class="dead-text">
                                <i class="w3-jumbo">scatter_plot</i>
                                <h4>No topics yet</h4>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% if iscreator and project.totalTopics > 0 %}<i class="edit-action w3-right" data-edittarget="projecttopics">edit</i>{% endif %}
                    </div>
                    {% if iscreator %}
                    <div id="edit-projecttopics">
                        <br/>
                        <strong class="dead-text">{% trans "Total 5 topics allowed" %}</strong>
                        <form class="no-auto" action="{{URLS.TOPICSUPDATE|params:project.getID}}" method="POST" id="edit-project-topics-form">
                            {% csrf_token %}
                            <input class="wide" placeholder="Search topics" id="topic-search-input" maxlength="35" />
                            <div class="w3-row w3-padding" id="topics-viewer">
                                {% for topic in project.getTopics %}
                                <button type="button" class="primary negative-text topic-existing" data-icon="close" id="{{topic.getID}}">{{topic.name}}</button>
                                {% endfor %}
                                <div class="w3-row w3-padding" id="topics-viewer-new"></div>
                            </div>
                            <input id="removetopicIDs" name="removetopicIDs" hidden type="text" />
                            <input id="addtopicIDs" name="addtopicIDs" hidden type="text" />
                            <input id="addtopics" name="addtopics" hidden type="text" />
                            <br/>
                            <button id="save-edit-projecttopics" data-icon="done">{% trans "Save" %}</button>
                            <button id="discard-edit-projecttopics" data-icon="close">{% trans "Cancel" %}</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="w3-row w3-padding" id="tags">
                <div id="view-projecttags">
                {% for tag in project.tags.all %}
                <a href="{{URLS.PROJECTS}}?search=tag:{{tag}}"><button class="positive">#{{tag}}</button></a>
                {% empty %}
                    <h5 class="dead-text">{% trans "No tags assigned" %}</h5>
                {% endfor %}
                {% if iscreator %}<i class="edit-action w3-right" data-edittarget="projecttags">edit</i>{% endif %}
                </div>
                {% if iscreator %}
                <div id="edit-projecttags">
                    <strong class="dead-text">{% trans "Total 5 tags allowed" %}</strong>
                    <form class="no-auto" id="edit-tag-inputs">
                        {% csrf_token %}
                        <input class="wide" placeholder="{% trans "Search tags" %}" id="tag-search-input" />
                        <div class="w3-row w3-padding" id="tags-viewer">
                            {% for tag in project.tags.all %}
                            <button type="button" class="primary negative-text tag-existing" data-icon="close" id="{{tag.id}}">{{tag.name}}</button>
                            {% endfor %}
                            <div class="w3-row w3-padding" id="tags-viewer-new"></div>
                        </div>
                        <input id="removetagIDs" name="removetagIDs" hidden type="text" />
                        <input id="addtagIDs" name="addtagIDs" hidden type="text" />
                        <input id="addtags" name="addtags" hidden type="text" />
                        <br/>
                        <button id="save-edit-projecttags" data-icon="done">{% trans "Save" %}</button>
                        <button id="discard-edit-projecttags" data-icon="close">{% trans "Cancel" %}</button>
                    </form>
                </div>
                {% endif %}
            </div>
            <div class="w3-row w3-padding pallete">
                <center><h5 class="align"><i>cloud_done</i>&nbsp;Assets</h5></center>
                <div class="w3-row">
                    {% for asset in project.assets %}

                    {% empty %}
                        {% if iscreator %}
                        <center >
                        <div class="w3-jumbo material-icons">add_circle</div>
                        <h5>Add assets</h5>
                        <strong class="dead-text">csv, xlsx, pdf... anything related to the project.</strong>
                        <strong class="dead-text">Coming soon</strong>
                        </center>
                        {% else %}
                        <br/>
                        <center class="dead-text">
                        <div class="w3-jumbo material-icons">cloud_off</div>
                        <h5>No assets</h5>
                        </center>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% if iscreator %}
            <br/>
            <div class="w3-row">
                <div class="pallete">
                <center><h5 class="align"><i class="w3-spin">settings</i>&nbsp;{% trans "Settings" %}</h5></center>
                <div class="w3-row">
                {% if project.has_linked_repo %}
                    <button class="negative" id='unlink-github-repository'><img src="{% static 'graphics/thirdparty/github-dark.png' %}" width="20"/>&nbsp;Unlink {{project.linked_repo.reponame}}</button>
                {% else %}
                    <button class="secondary" id="link-github-repository"><img src="{% static 'graphics/thirdparty/github-dark.png' %}" width="20"/>&nbsp;Link repository</button>
                {% endif %}
                </div>
                <div class="w3-row">
                    {% if project.under_invitation %}
                        <h6>Transfer invited</h6>
                        <a onclick="miniWindow('{{project.current_invitation.receiver.get_link}}')"><button class="primary"><img class="circle" src="{{project.current_invitation.receiver.get_dp}}" width="25" />{{project.current_invitation.receiver.get_name}}</button></a>
                        <b>till {{project.current_invitation.expiresOn}}</b>
                        <button class="negative small" id='delete-project-invitation' data-icon="delete">Delete</button>
                    {% endif %}
                    <br/>
                    {% if project.can_invite_owner %}
                    <button class="negative" id='transfer-project' data-icon="schedule_send">Transfer Project</button>
                    {% endif %}
                    {% if project.can_delete %}
                    <button class="negative" data-icon="delete" id='delete-project'>{% trans "Delete project" %}</button>
                    {% endif %}
                    {% if project.under_verification_request %}
                        <h6>Under verification review</h6>
                        <a href="{{project.current_verification_request.getLink}}" target="_blank"><button class="accent" data-icon="open_in_new">View verification status</button></a>
                        <button class="negative" id="cancel-verification-request" data-icon="close">Cancel verification request</button>
                    {% endif %}
                    {% if project.can_request_verification %}
                        <button class="accent" id="request-verification" data-icon="pending">Request verification</button>
                    {% endif %}
                </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="w3-col w3-half w3-padding">
            <div class="w3-row">
                <div class="pallete">
                    <center><h5 class="align"><i>description</i>&nbsp;Description</h5></center><br/>
                    <strong>{% trans "Created on" %} <span>{{project.createdOn}}</span></strong><br/><br/>
                    <strong>{% trans "Created by" %}</strong><a href="{{project.creator.getLink}}"><button class="primary"><img class="circle" src="{{project.creator.getDP}}"  width="20"/>&nbsp;{{project.creator.getName}}{% if project.creator.is_verified %}<i class="positive-text w3-large">verified</i>{% endif %}</button></a><br/><br/>
                    <strong>{% trans "License" %}: <a onclick="miniWindow('{{project.license.getLink}}')" target="_blank"> {{project.license.name}}</a></strong><br/>
                </div>
            </div>
            <br/>
            <div class="w3-row pallete no-pad" id="snaps">
                <center><h5 class="w3-padding align"><i>camera</i>&nbsp;Snapshots</h5>
                {% if iscreator %}
                <div class="w3-row" id="view-snapshot">
                    <button class="small primary edit-action" data-icon='add' id="create-snap" data-edittarget="snapshot">Create</button>
                </div>
                <div class="w3-row" id="edit-snapshot">
                    <input type='file' hidden id='snap-file' accept="image/png, image/jpg, image/jpeg" />
                    <form action="{{URLS.SNAPSHOT|params:project.get_id|params:'create'}}" method="POST">
                        {% csrf_token %}
                        <textarea class="wide snapshot-input" name='snaptext' rows="3" placeholder="Status report, or anything."></textarea>
                        <input class="snapshot-input" type="text" id='snapimage' name='snapimage' hidden />
                        <img width='100%' id='snapimageview' hidden class="snapshot-image preview-type-image" />
                        <div class="dead-text" id='add-image-view'>
                            <label for="snap-file">
                                <div class="w3-jumbo material-icons">add_circle</div>
                                <h5>Add image</h5>
                            </label>
                        </div>
                        <button class="small positive" type='submit' id="save-edit-snapshot" data-icon="done">{% trans "Publish snapshot" %}</button>
                        <button class="small negative" type='button' id="discard-edit-snapshot" data-icon="close">{% trans "Discard" %}</button>
                    </form>
                    <hr/>
                </div>
                {% endif %}
                </center>
                <div class="w3-row" id="snapshots-view">
                </div>
                <br/>
                <center><button class="small primary" data-icon='expand_more' hidden id='load-more-snaps'>{% trans "Load more" %}</button></center>
                <br/>
            </div>
            
        </div>
    </div>
    <div class="w3-row"></div>
    <br/>
{% endif %}
</div>
{% endblock %}

{% block in_scripts %}
<script>
const projectID = "{{ project.get_id }}";
const selfProject = "{{iscreator}}"==='True';
const ismoderator = false;
const projectcolor = getComputedStyle(document.querySelector(':root')).getPropertyValue('--positive');

{% if not project.suspended %}
{% if iscreator %}
    getElement('save-edit-projecttags').onclick= async ()=> {
        var obj = getFormDataById("edit-tag-inputs");
        var resp=await postRequest(setUrlParams(URLS.TAGSUPDATE, projectID), {
            addtagIDs:obj.addtagIDs.split(',').filter((str)=>str),addtags:obj.addtags.split(',').filter((str)=>str),removetagIDs:obj.removetagIDs.split(',').filter((str)=>str)
        });
        if (resp.code===code.OK){
            subLoader()
            return window.location.reload()
        }
        error(resp.error)
    }

    {% if project.can_delete %}
    getElement('delete-project').onclick=_=>{
        Swal.fire({
            title: '{% trans "Delete Project" %}',
            html: `<h4>Are you sure you want to delete your project '{{project.name}}' ({{project.nickname}})? All associated data will also be deleted, and
                    this action is permanent.</h4>`,
            showDenyButton: true,
            showCancelButton: false,
            denyButtonText: 'Yes, DELETE',
            confirmButtonText: 'No, wait!',
        }).then(async(result)=>{
            if(result.isDenied){
                loader()
                const data = await postRequest2({path:setUrlParams(URLS.TRASH,projectID)})
                if(!data) return loader(false)
                if(data.code===code.OK){
                    futuremessage('{{project.nickname}} was deleted.')
                    return window.location.href=URLS.PROJECTS
                }
                error(data.error)
                loader(false)
            } else {
                message('Phew!')
            }
        })
    }
    {% endif %}
    {% if project.can_invite_owner %}
    getElement('transfer-project').onclick=(e)=>{
        Swal.fire({
            title: 'Transfer project',
            html: `<h6>Transfer project '{{project.nickname}}' to another user.<br/>
            Invite the new owner by their email to transfer project.</h6>
            <br/>
            <input class="wide" type="email" autocomplete="email" placeholder="New email address" id="transfer-project-new-email" />
            `,
            showCancelButton: true,
            confirmButtonText: 'Send Invite',
            cancelButtonText: 'Cancel',
            showLoaderOnConfirm: true,
            preConfirm: async () => {
                let email = getElement("transfer-project-new-email").value.trim()
                if(email) return email
                error('New email address required')
                return false
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                message("Sending invitation...");
                const data = await postRequest2({
                    path: URLS.INVITE_PROJECT_OWNER,
                    data: {
                        action: 'create',
                        projectID,
                        email: result.value,
                    }
                })
                if(data.code===code.OK){
                    futuremessage("Invitation sent.")
                    return window.location.reload()
                }
                error(data.error)
            }
        })
    }
    {% elif project.under_invitation %}
        getElement('delete-project-invitation').onclick=async(e)=>{
            message("Deleting invitation...");
            const data = await postRequest2({
                path: URLS.INVITE_PROJECT_OWNER,
                data: {
                    action: 'remove',
                    projectID,
                }
            })
            if(data.code===code.OK){
                futuremessage("Invitation cancelled")
                return window.location.reload()
            }
            error(data.error)
        }
    {% endif %}

    getElement('sociallinks-add').onclick=_=>{
        const parent=getElement('edit-sociallinks-inputs');
        if(parent.childElementCount===5) return message('Maximun URLs limit reached')
        const linkNumber=parent.childElementCount+1;
        const newChild=document.createElement('div');
        newChild.innerHTML = `
            <input class="wide" type="url" inputmode="url" placeholder="Link to anything relevant" name="sociallink${linkNumber}" id=sociallink${linkNumber} /><br/><br/>
        `;
        parent.insertBefore(newChild,parent.childNodes[0]);
    }

    {% if project.can_request_verification %}
    getElement('request-verification').onclick=async(e)=>{
        Swal.fire({
            title: 'Request verification',
            html: `
                <strong>By requesting verification, you are submitting your project for review by an appropriate moderator at {{APPNAME}}.
                If approved, your project will no longer exist as Quick project, and your linked repository will be removed from it,
                and your project will become a verified project on Knotters with a separate repository from Knotters.
                License will remain the same.</strong>
                <br/><br/>
                
                Project detail for moderator to read<br/>
                <textarea class="wide" placeholder="Reason for verification" id="request-verification-reason"></textarea>
                <br/>
                Maximum days to review<br/>
                <input type="number" class="wide" min="1" max="15" placeholder="Stale days (min 1, max 15)" value="3" id="request-verification-stale-days" />
                <br/>
                {% if request.user.profile.is_manager %}
                Use internal moderator
                <input type="checkbox" id="request-verification-internal" />
                {% endif %}
                
            `,
            showCancelButton: true,
            confirmButtonText: 'Send Request',
            cancelButtonText: 'Cancel',
            preConfirm: async () => {
                const requestData = getElement('request-verification-reason').value.trim()
                if(!requestData) {
                    error('Reason required')
                    return false
                }
                const stale_days = getElement('request-verification-stale-days').value
                if(!stale_days) {
                    error('Stale days required')
                    return false
                }
                return {
                    requestData,
                    stale_days:Number(stale_days), 
                    {% if request.user.profile.is_manager %}
                    internalMod:getElement('request-verification-internal').checked
                    {% endif %}
                }
            }
        }).then(async(result)=>{
            if(result.isConfirmed){
                loader()
                message("Sending request...");
                const data = await postRequest2({
                    path: setUrlParams(URLS.FREE_VERIFICATION_REQUEST),
                    data: {
                        action: 'create',
                        projectID,
                        requestData: result.value.requestData,
                        stale_days:result.value.stale_days,
                        useInternalMods:result.value.internalMod||false,
                    }
                })
                if(data.code===CODE.OK){
                    futuremessage("Verification request sent.")
                    return window.location.reload()
                }
                loader(false)
                error(data.error)
            }
        })
    }
    {% elif project.under_verification_request %}
    getElement('cancel-verification-request').onclick=async(e)=>{
        Swal.fire({
            title: 'Cancel verification request',
            html: `
                <strong>By cancelling verification request, you are cancelling your project's verification request.
                The assigned moderator will no longer be able to review your project.
                Please note that if the project has already been approved before you could cancel the request,
                then cancellation will not be possible, and this quick project may already have been deleted.</strong>
            `,
            showCancelButton: false,
            showDenyButton: true,
            confirmButtonText: 'No, wait!',
            denyButtonText: 'Cancel verification',
        }).then(async(result)=>{
            if(result.isDenied){
                loader()
                message("Cancelling verification request...");
                const data = await postRequest2({
                    path: setUrlParams(URLS.FREE_VERIFICATION_REQUEST),
                    data: {
                        action: 'remove',
                        projectID,
                    }
                })
                if(data.code===CODE.OK){
                    futuremessage("Verification request cancelled.")
                    return window.location.reload()
                }
                loader(false)
                error(data.error)
            }
        })
    }
    {% endif %}
    {% if not project.has_linked_repo %}
    getElement('link-github-repository').onclick=async()=>{
        {% if request.user.profile.ghID %}
            loader()
            const data = await postRequest2({path:URLS.USER_GH_REPOS,data:{public:true}, retainCache: true});
            
            loader(false)
            if(!data) return
            if(data.code===code.OK){
                let options = '';
                data.repos.forEach((repo)=>{
                    if(!repo.taken)
                        options+=`<option value=${repo.id}>${repo.name}</option>`
                })
                return Swal.fire({
                    title: 'Link GitHub repository',
                    imageUrl: "{% static 'graphics/thirdparty/github.png' %}",
                    imageWidth:50,
                    html: `<h6>Link GitHub repository to project '{{project.nickname}}'.<br/>Only public repositories can be linked.</h6>
                    <br/>
                    <select class="wide pallete-slab" id="link-github-repository-select">
                        ${options}
                    </select>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Link',
                    cancelButtonText: 'Cancel',
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        let repoID = getElement("link-github-repository-select").value
                        if(repoID) return repoID
                        error('Repository required')
                        return false
                    }
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        loader()
                        message("Linking repository...");
                        const data = await postRequest2({
                            path: URLS.LINK_FREE_REPO,
                            data: {
                                projectID,
                                repoID: result.value,
                            }
                        })
                        if(data.code===code.OK){
                            futuremessage("Repository linked.")
                            return window.location.reload()
                        }
                        loader(false)
                        error(data.error)
                    }
                })
            }
            error(data.error)
        {% else %}
            connectWithGithub("{{project.getLink}}", ()=>{ error("Cannot link repository without linking account.")})
        {% endif %}
    }
    {% else %}
    getElement("unlink-github-repository").onclick=_=>{
        Swal.fire({
            title: 'Unlink Github repository?',
            html:`<h6>Are you sure you want to unlink your Github repository '{{project.linked_repo.reponame}}' from your '{{project.nickname}}' project on {{APPNAME}}?</h6>`,
            showCancelButton: true,
            showDenyButton: true,
            showConfirmButton: false,
            denyButtonText: 'Yes, Unlink',
            cancelButtonText: 'No, wait',
        }).then(async(result)=>{
            if(result.isDenied){
                loader()
                message('Unlinking...')
                const data = await postRequest2({path:URLS.UNLINK_FREE_REPO,data:{projectID}})
                if(!data) return loader(false)
                if(data.code===code.OK){
                    futuremessage(`Unlinked your '{{project.linked_repo.reponame}}' repository`)
                    return window.location.reload()
                }
                loader(false)
                error(data.error)
            }
        })
    }
        {% if not project.linked_repo.has_installed_app %}
            Swal.fire({
                title: 'Setup Knottersbot in repository ',
                html:`<h6>To track contribution record in {{project.nickname}} github repository, it is highly recommended that you install our Knotters Bot on GitHub.</h6>`,
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: 'Setup Knotters Bot',
                cancelButtonText: 'No, wait',
                allowOutsideClick: false
            }).then(async(result)=>{
                if(result.isConfirmed){
                    miniWindow("https://github.com/apps/knotters-bot/installations/new/permissions?target_id={{request.user.profile.gh_user.id}}")
                }
            })
            
        {% elif project.linked_repo.installed_app.suspended %}
            Swal.fire({
                title: 'Knottersbot suspended',
                html:`<h6>To track contribution record in your {{project.nickname}} github repository, please unsuspend Knotters Bot on GitHub.</h6>`,
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: 'Setup Knotters Bot',
                cancelButtonText: 'No, wait',
                allowOutsideClick: false
            }).then(async(result)=>{
                if(result.isConfirmed){
                    miniWindow("https://github.com/apps/knotters-bot/installations/new/permissions?target_id={{request.user.profile.gh_user.id}}")
                }
            })
        {% endif %}
    {% endif %}
    getElement('save-edit-snapshot').onclick=(e)=>{
        e.preventDefault();
        e.target.form.submit()
    }
{% else %}
    if(authenticated){
        getElement('report-project').onclick=async()=>{
            await violationReportDialog(URLS.REPORT_PROJECT,{projectID},"{{project.nickname}}", URLS.REPORT_CATEGORIES)   
        }
    }
{% endif %}
getElement('show-admirations').onclick=async(_)=>{
    Swal.fire({ 
        html: await getRequest2({ path:setUrlParams(URLS.ADMIRATIONS, projectID)}), 
        title:"<h4 class='positive-text'>Admirers</h4>"
    })
}
{% endif %}
</script>
{% endblock %}
{% block scripts %}
{% if not project.suspended %}
<script src="{% static 'scripts/project/profile.js' %}" ></script>
{% endif %}
{% endblock %}
